{% extends 'main/base.html' %}

{% block content %}
<div class="calendar-container">
    <div class="calendar-header">
        <h2 id="currentMonthYear"></h2>
        <div>
            <button class="nav-btn" onclick="previousMonth()"><i class="fas fa-chevron-left"></i></button>
            <button class="nav-btn" onclick="nextMonth()"><i class="fas fa-chevron-right"></i></button>
        </div>
    </div>
    <div class="calendar">
        <div class="weekdays">
            <div class="weekday-header">Pzt</div>
            <div class="weekday-header">Sal</div>
            <div class="weekday-header">Çar</div>
            <div class="weekday-header">Per</div>
            <div class="weekday-header">Cum</div>
            <div class="weekday-header">Cmt</div>
            <div class="weekday-header">Paz</div>
        </div>
        <div id="calendarDays" class="calendar-days"></div>
    </div>
</div>

<!-- Günlük Modal -->
<div id="diaryModal" class="diary-modal">
    <div class="diary-content">
        <div class="diary-header">
            <h2 id="diaryDate"></h2>
            <button class="close-btn" onclick="closeDiaryModal()">&times;</button>
        </div>
        <div id="diaryForm">
            <input type="text" id="diaryTitle" class="diary-title-input" placeholder="Günlük başlığı">
            <textarea id="diaryContent" class="diary-textarea" placeholder="Bugün neler yaşadın?"></textarea>
            <button class="save-btn" onclick="saveDiary()">Kaydet</button>
        </div>
        <div id="diaryEntries" class="diary-entries">
            <!-- Günlük girişleri buraya eklenecek -->
        </div>
    </div>
</div>

<style>
    .calendar-container {
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .calendar-header {
        text-align: center;
        margin-bottom: 20px;
    }
    
    .calendar {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    
    .weekdays {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        background: #f8f9fa;
        padding: 10px 0;
    }
    
    .weekday-header {
        text-align: center;
        font-weight: bold;
    }
    
    .calendar-days {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background: #dee2e6;
        padding: 1px;
    }
    
    .calendar-day {
        background: white;
        aspect-ratio: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 8px;
        cursor: pointer;
    }
    
    .calendar-day:hover {
        background: #f8f9fa;
    }
    
    .calendar-day.has-diary {
        font-weight: bold;
        color: #1877f2;
    }
    
    .calendar-day.empty {
        background: #f8f9fa;
        cursor: default;
    }
    
    .diary-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        overflow-y: auto;
    }
    
    .diary-content {
        background: white;
        margin: 50px auto;
        padding: 20px;
        width: 90%;
        max-width: 600px;
        border-radius: 10px;
        max-height: 80vh;
        overflow-y: auto;
        display: flex;
        flex-direction: column;
    }
    
    .diary-header {
        position: sticky;
        top: 0;
        background: white;
        padding: 10px 0;
        border-bottom: 1px solid #eee;
        margin-bottom: 15px;
        z-index: 1;
    }
    
    #diaryForm {
        margin-bottom: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .diary-entry {
        background: #fff;
        padding: 15px;
        margin-bottom: 15px;
        border: 1px solid #dee2e6;
        border-radius: 8px;
    }
    
    .entry-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px solid #eee;
    }
    
    .entry-header h4 {
        margin: 0;
        color: #333;
    }
    
    .entry-header small {
        color: #666;
    }
    
    .diary-entry p {
        margin: 0;
        color: #555;
        line-height: 1.5;
    }

    .diary-title-input {
        width: 100%;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    
    .diary-textarea {
        width: 100%;
        min-height: 100px;
        padding: 8px;
        margin-bottom: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        resize: vertical;
    }
    
    .save-btn {
        background: #007bff;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        cursor: pointer;
    }
    
    .save-btn:hover {
        background: #0056b3;
    }
    
    .diary-entry-header {
        display: flex;
        justify-content: space-between;
        margin-bottom: 10px;
        color: #666;
        font-size: 0.9em;
    }
    
    .diary-entry-title {
        font-weight: bold;
        margin-bottom: 10px;
    }
    
    .diary-entry-content {
        white-space: pre-wrap;
    }
</style>

<script>
    let currentMonth = {{ current_month }};
    let currentYear = {{ current_year }};
    const diaryDates = {{ diary_dates|safe }};
    
    function updateCalendar() {
        const calendarDays = document.getElementById('calendarDays');
        const monthYearElement = document.getElementById('currentMonthYear');
        
        // Ay ve yıl başlığını güncelle
        const date = new Date(currentYear, currentMonth - 1, 1);
        monthYearElement.textContent = date.toLocaleDateString('tr-TR', { 
            month: 'long', 
            year: 'numeric' 
        });
        
        calendarDays.innerHTML = '';
        
        // Ayın ilk gününü bul
        const firstDay = new Date(currentYear, currentMonth - 1, 1).getDay();
        const startDay = firstDay === 0 ? 6 : firstDay - 1;
        
        // Ayın son gününü bul
        const lastDay = new Date(currentYear, currentMonth, 0).getDate();
        
        // Boş günler
        for (let i = 0; i < startDay; i++) {
            const emptyDay = document.createElement('div');
            emptyDay.className = 'calendar-day empty';
            calendarDays.appendChild(emptyDay);
        }
        
        // Ayın günleri
        for (let day = 1; day <= lastDay; day++) {
            const dayElement = document.createElement('div');
            dayElement.className = 'calendar-day';
            dayElement.textContent = day;
            
            if (diaryDates[day]) {
                dayElement.classList.add('has-diary');
            }
            
            dayElement.addEventListener('click', () => openDiaryModal(day));
            calendarDays.appendChild(dayElement);
        }
    }
    
    function previousMonth() {
        currentMonth--;
        if (currentMonth < 1) {
            currentMonth = 12;
            currentYear--;
        }
        window.location.href = `/calendar/?month=${currentMonth}&year=${currentYear}`;
    }
    
    function nextMonth() {
        currentMonth++;
        if (currentMonth > 12) {
            currentMonth = 1;
            currentYear++;
        }
        window.location.href = `/calendar/?month=${currentMonth}&year=${currentYear}`;
    }
    
    function openDiaryModal(day) {
        const modal = document.getElementById('diaryModal');
        const diaryDate = document.getElementById('diaryDate');
        const diaryEntries = document.getElementById('diaryEntries');
        
        // Tarihi formatla
        const date = new Date(currentYear, currentMonth - 1, day);
        const formattedDate = date.toISOString().split('T')[0];
        diaryDate.textContent = formattedDate;
        
        // Mevcut girişleri getir
        fetch(`/diary/entries/${formattedDate}/`)
            .then(response => response.json())
            .then(data => {
                diaryEntries.innerHTML = '';
                data.entries.forEach(entry => {
                    const entryDiv = document.createElement('div');
                    entryDiv.className = 'diary-entry';
                    entryDiv.innerHTML = `
                        <div class="entry-header">
                            <h4>${entry.title}</h4>
                            <small>Oluşturan: ${entry.created_by}</small>
                        </div>
                        <p>${entry.content}</p>
                    `;
                    diaryEntries.appendChild(entryDiv);
                });
            });
        
        modal.style.display = 'block';
    }
    
    function closeDiaryModal() {
        document.getElementById('diaryModal').style.display = 'none';
    }
    
    function saveDiary() {
        const day = parseInt(document.getElementById('diaryDate').textContent.split(' ')[0]);
        const title = document.getElementById('diaryTitle').value.trim();
        const content = document.getElementById('diaryContent').value.trim();
        
        if (!content) {
            alert('Lütfen günlük içeriği giriniz.');
            return;
        }
        
        const date = `${currentYear}-${String(currentMonth).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
        
        fetch('/diary/save/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({
                date: date,
                title: title,
                content: content
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                location.reload();
            }
        });
    }
    
    // Takvimi güncelle
    updateCalendar();
</script>
{% endblock %}
